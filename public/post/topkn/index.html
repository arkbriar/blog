<!DOCTYPE html>
<html>

<head>
  <title> 2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€) &middot; crazy.ark </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.25.1" />


<link rel="stylesheet" href="https://arkbriar.tk/css/vec.css">
<link rel="stylesheet" href="https://arkbriar.tk/css/katex.min.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/favicon.ico">


<link href="" rel="alternate" type="application/rss+xml" title="crazy.ark" />

</head>

<body>
  <header>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://arkbriar.tk/">/home/crazy.ark</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/about">~/about</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/contact">~/contact</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://ericfu.me">~/coding husky</a>
      </li>
      
      
      <li class="pull-left current">
        <a href="/post">~/post</a>
      </li>
      
  
      <li class="pull-right"><a href=""><i class="fa fa-rss"></i></a></li>
    </ul>
  </nav>
</header>
  <div class="content">
    
    
    <section class="post">
      <h1 class="post-title"><a href="https://arkbriar.tk/post/topkn/">2017 Alibaba Middleware 24h Final (Just for Fun ğŸ˜€)</a></h1>
      <span class="post-date">Jul 26, 2017 </span>
      <div class="post-content">
        <p>ä»Šå¹´é˜¿é‡Œä¸­é—´ä»¶æ¯”èµ›çš„æ—¶å€™ä¸å·§åšä¸»å¿ƒæƒ…ä¸å¥½ï¼Œå¤–åŠ è¦å‡†å¤‡æœŸæœ«è€ƒè¯•ï¼Œå¹¶æ²¡æœ‰å‚åŠ ï¼Œéå¸¸é—æ†¾ã€‚ä¸è¿‡å¥½åœ¨å¥½åŸºå‹ <a href="https://ericfu.me">Eric Fu</a> å‚åŠ å¹¶è·å¾—äº†å† å†›ï¼ä»Šå¹´çš„ä¸»é¢˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå¦‚æœæƒ³äº†è§£è¯¦æƒ…åŠå¤èµ›çš„è§£é¢˜æ€è·¯è¯·è¯»è€…å‰å¾€ Eric çš„åšå®¢ã€‚</p>

<p>åšä¸»æ²¡æœ‰å‚åŠ ç”šæ˜¯é—æ†¾ï¼Œå¤–åŠ çœ‹åˆ°é¢˜ç›®æ‰‹ç—’éš¾è€ï¼Œé‚é—®åŸºå‹è®¨äº†æœ€åçš„24hæå®¢èµ›æ¥ç©ä¸€ç©ã€‚</p>

<h2 id="24h-topkn">24h TOPKN</h2>

<p>é¢˜ç›®æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ä¸Šçš„åˆ†é¡µæ’åºï¼Œå¯¹åº”çš„SQLæ‰§è¡Œä¸º order by id limit kï¼Œnï¼›ä¸»è¦çš„æŠ€æœ¯æŒ‘æˆ˜ä¸º&quot;åˆ†å¸ƒå¼&quot;çš„ç­–ç•¥ï¼Œèµ›é¢˜ä¸­ä½¿ç”¨å¤šä¸ªæ–‡ä»¶æ¨¡æ‹Ÿå¤šä¸ªæ•°æ®åˆ†ç‰‡ã€‚</p>

<p>ç®€ç§° top(k, n)ã€‚</p>

<p></p>

<blockquote>
<p>ç»™å®šä¸€æ‰¹æ•°æ®ï¼Œæ±‚è§£æŒ‰é¡ºåºä»å°åˆ°å¤§ï¼Œé¡ºåºæ’åä»ç¬¬kä¸‹æ ‡åºå·ä¹‹åè¿ç»­çš„nä¸ªæ•°æ® (ç±»ä¼¼äºæ•°æ®åº“çš„order by asc + limit k,nè¯­ä¹‰)</p>

<p>top(k,3)ä»£è¡¨è·å–æ’ååºå·ä¸ºk+1,k+2,k+3çš„å†…å®¹,ä¾‹:top(10,3)ä»£è¡¨åºå·ä¸º11ã€12ã€13çš„å†…å®¹,top(0,3)ä»£è¡¨åºå·ä¸º1ã€2ã€3çš„å†…å®¹
éœ€è¦è€ƒè™‘kå€¼å‡ ç§æƒ…å†µï¼Œkå€¼æ¯”è¾ƒå°æˆ–è€…ç‰¹åˆ«å¤§çš„æƒ…å†µï¼Œæ¯”å¦‚k=1,000,000,000
å¯¹åº”k,nå–å€¼èŒƒå›´ï¼š 0 &lt;= k &lt; 2^63 å’Œ 0 &lt; n &lt; 100
æ•°æ®å…¨éƒ¨æ˜¯æ–‡æœ¬å’Œæ•°å­—ç»“åˆçš„æ•°æ®ï¼Œæ’åºçš„æ—¶å€™æŒ‰ç…§æ•´ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æ¥æ’åºã€‚ä¾‹å¦‚ä¸€ä¸ªæœ‰åºçš„æ’åºå¦‚ä¸‹(ç›¸åŒé•¿åº¦æƒ…å†µä¸‹asciiç å°çš„æ’åœ¨å‰é¢)ï¼š
ä¾‹ï¼š a ab abc def abc123</p>

<p>ä¾‹å¦‚ç»™å®šçš„k,nä¸º(2,2)ï¼Œåˆ™ä¸Šé¢çš„æ•°æ®éœ€è¦çš„ç­”æ¡ˆä¸º: abc def</p>
</blockquote>

<p>åŸé¢˜ç›®åœ¨ <a href="https://code.aliyun.com/wanshao/topkn_final">https://code.aliyun.com/wanshao/topkn_final</a>ã€‚</p>

<p>è¦æ±‚åœ¨24å°æ—¶å†…å®Œæˆï¼Œç„¶è€Œ ...</p>

<p>Codes æ‰˜ç®¡åœ¨ github ä¸Š <a href="https://github.com/arkbriar/topKN">https://github.com/arkbriar/topKN</a>ï¼Œè¿™ä¸ªç‰ˆæœ¬ä»åŸºå‹çš„ç‰ˆæœ¬è½»åº¦ä¿®æ”¹è€Œæ¥ ...</p>

<h2 id="è§£é¢˜è¿‡ç¨‹">è§£é¢˜è¿‡ç¨‹</h2>

<table>
<thead>
<tr>
<th align="left"><strong>ä¸»è¦æ¡ä»¶</strong></th>
<th align="center"></th>
<th align="left"><strong>ä¸»è¦é™åˆ¶</strong></th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">1. 3å°æœºå™¨: 2å°workerï¼Œ1å°master <br /> 2. è¾“å‡ºåœ¨masterä¸Š</td>
<td align="center"></td>
<td align="left">1. Timeout: 5min <br /> 2. JVM heap size: 3G <br/> 3. ä¸å…è®¸ä½¿ç”¨å †å¤–å†…å­˜(FileChannel)</td>
</tr>
</tbody>
</table>

<p><br />
é¢˜ç›®ä¸­ä¸€å…±æœ‰å¤§çº¦160000000æ¡æ•°æ®(å­—ç¬¦ä¸²)ï¼Œå¹¶åˆ†å¸ƒåœ¨ä¸¤å°æœºå™¨ä¸Šï¼Œè¦è¿›è¡Œ top(k, n)ï¼Œé¦–å…ˆ brute force ä¸€å®šæ˜¯ä¸è¡Œçš„ã€‚</p>

<p>å¦‚æœè¦å¯¹160000000æ¡æ•°æ®å…¨æ’åºJVMï¼Œç¬¬ä¸€å†…å­˜å¤ªå°ï¼Œç¬¬äºŒæ—¶é—´ä¸å¤Ÿã€‚å¯¹ 10000000 æ¡æ•°æ®è¿›è¡Œæ’åºå¤§çº¦è€—æ—¶ä¸º 1min13sï¼Œå‚è€ƒè‡ª <a href="https://codereview.stackexchange.com/questions/67387/quicksort-implementation-seems-too-slow-with-large-data">https://codereview.stackexchange.com/questions/67387/quicksort-implementation-seems-too-slow-with-large-data</a>ï¼›å¦‚æœè¦è¿›è¡Œå¤–æ’åºï¼Œç£ç›˜è¯»å†™å¯¼è‡´è€—æ—¶æ›´é•¿ï¼›ä»¥åŠè¿˜æœ‰æœ€åè¦è¾“å‡ºåˆ°masterä¸Šï¼Œè¿˜æœ‰ç½‘ç»œå¼€é”€ã€‚</p>

<p>ç¨å¾®äº†è§£ä¸€äº›æ•°æ®åº“çš„åŒå­¦éƒ½çŸ¥é“ï¼Œæ•°æ®åº“é‡Œæœ‰ä¸ªå«ç´¢å¼•(Index)çš„ä¸œè¥¿ï¼Œæ˜¯ç”¨æ¥åŠ é€ŸæŸ¥è¯¢çš„ã€‚é‚£æˆ‘ä»¬é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ MySQL çš„ç´¢å¼•ã€‚</p>

<h3 id="mysql-çš„ç´¢å¼•">MySQL çš„ç´¢å¼•</h3>

<p>ç´¢å¼•å¯¹æŸ¥è¯¢çš„é€Ÿåº¦æœ‰è‡³å…³é‡è¦çš„å½±å“ï¼Œç†è§£ç´¢å¼•ä¹Ÿæ˜¯è¿›è¡Œæ•°æ®åº“æ€§èƒ½è°ƒä¼˜çš„èµ·ç‚¹ã€‚å‡è®¾æ•°æ®åº“ä¸­ä¸€ä¸ªè¡¨æœ‰100000æ¡è®°å½•ï¼ŒDBMSçš„é¡µé¢å¤§å°ä¸º4Kï¼Œå¹¶å­˜å‚¨100æ¡è®°å½•ã€‚å¦‚æœæ²¡æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢å°†å¯¹æ•´ä¸ªè¡¨è¿›è¡Œæ‰«æï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ‰€æœ‰æ•°æ®é¡µéƒ½ä¸åœ¨å†…å­˜ï¼Œéœ€è¦è¯»å–10000ä¸ªé¡µé¢ï¼Œå¦‚æœè¿™10000ä¸ªé¡µé¢åœ¨ç£ç›˜ä¸Šéšæœºåˆ†å¸ƒï¼Œéœ€è¦è¿›è¡Œ10000æ¬¡I/Oï¼Œå‡è®¾ç£ç›˜æ¯æ¬¡I/Oæ—¶é—´ä¸º10msï¼Œåˆ™æ€»å…±éœ€è¦100s(å®é™…è¿œä¸æ­¢)ã€‚ä½†æ˜¯å¦‚æœå»ºç«‹ B+ æ ‘ç´¢å¼•ï¼Œåˆ™åªéœ€è¦è¿›è¡Œ <span  class="math">\(log_{100}1000000 = 3\)</span>æ¬¡é¡µé¢è¯»å–ï¼Œæœ€åæƒ…å†µä¸‹è€—æ—¶30msï¼Œè¿™å°±æ˜¯ç´¢å¼•å¸¦æ¥çš„æ•ˆæœã€‚</p>

<p>MySQL æœ‰ä¸¤ç§ç´¢å¼•çš„ç±»å‹ï¼šB+æ ‘å’ŒHashç´¢å¼•ã€‚</p>

<p>å‚è€ƒè‡ª <a href="http://www.cnblogs.com/hustcat/archive/2009/10/28/1591648.html">http://www.cnblogs.com/hustcat/archive/2009/10/28/1591648.html</a></p>

<h3 id="bb-æ ‘">B/B+ æ ‘</h3>

<p>æˆ‘ä»¬éƒ½çŸ¥é“RB-Treeå’ŒAVL-Treeæ˜¯éƒ½æ˜¯è‡ªå¹³è¡¡çš„äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œåœ¨è¿™æ ·çš„æ ‘ä¸Šè¿›è¡Œæ’å…¥ï¼Œåˆ é™¤å’ŒæŸ¥è¯¢æ“ä½œæœ€åæƒ…å†µéƒ½èƒ½åœ¨<span  class="math">\(O(log_{2}n)\)</span>çš„æ—¶é—´å†…å®Œæˆã€‚</p>

<p>Bæ ‘æ˜¯1972å¹´ç”± Rudolf Bayer å’Œ Edward M.McCreight æå‡ºçš„ï¼Œå®ƒæ˜¯ä¸€ç§æ³›åŒ–çš„è‡ªå¹³è¡¡æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šäºä¸¤ä¸ªçš„å­èŠ‚ç‚¹ã€‚ä¸è‡ªå¹³è¡¡äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒçš„æ˜¯ï¼ŒBæ ‘ä¸ºç³»ç»Ÿå¤§å—æ•°æ®çš„è¯»å†™æ“ä½œåšäº†ä¼˜åŒ–ã€‚Bæ ‘å‡å°‘å®šä½è®°å½•æ—¶æ‰€ç»å†çš„ä¸­é—´è¿‡ç¨‹ï¼Œä»è€ŒåŠ å¿«å­˜å–é€Ÿåº¦ã€‚æ‰€ä»¥Bæ ‘å¸¸è¢«åº”ç”¨äºæ•°æ®åº“å’Œæ–‡ä»¶ç³»ç»Ÿçš„å®ç°ã€‚</p>

<p>å‡è®¾Bæ ‘æ¯ä¸ªèŠ‚ç‚¹ä¸‹æœ‰bä¸ªå­èŠ‚ç‚¹(bä¸ªåˆ†å—)ï¼Œé‚£ä¹ˆæŸ¥æ‰¾å¯ä»¥åœ¨çº¦ä¸ºlogbNçš„ç£ç›˜è¯»å–å¼€é”€ä¸‹å®Œæˆã€‚</p>

<p>å…³äº B/B+ æ ‘çš„å…¶ä»–ç‰¹å¾åœ¨ç»´åŸºå’Œå…¶ä»–èµ„æ–™ä¸Šæœ‰è¯¦ç»†è®²è§£ï¼Œåœ¨æ­¤ä¸å†èµ˜è¿°ã€‚</p>

<p>ç”±äºæ—¶é—´é™å®šçš„ç¼˜æ•…ï¼Œå®ç° B/B+ æ ‘çš„ç´¢å¼•æ˜¾å¾—ä¸å¤ªç°å®ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†è€ƒè™‘ä¸€ç§é€€åŒ–çš„æ–¹å¼ â€”â€” æ¡¶æ’åºã€‚</p>

<p>å‚è€ƒè‡ª</p>

<ol>
<li><a href="https://zh.wikipedia.org/wiki/B%E6%A0%91">https://zh.wikipedia.org/wiki/B%E6%A0%91</a></li>
<li><a href="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91">https://zh.wikipedia.org/wiki/B%2B%E6%A0%91</a></li>
</ol>

<h3 id="æ¡¶æ’åº">æ¡¶æ’åº</h3>

<p>å…ˆæ¥çœ‹ä¸€ä¸‹æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼š</p>

<blockquote>
<p>æ¯ä¸€è¡Œå­—ç¬¦ä¸²çš„é•¿åº¦ä¸º [1,128] ï¼ˆæ•°å­—åœ¨Longå€¼èŒƒå›´å†…å‡åŒ€åˆ†å¸ƒï¼‰</p>
</blockquote>

<p>æ˜¾ç„¶ä»¥å­—ç¬¦ä¸²é•¿æ¥æ ‡è¯†æ¡¶æ˜¯å¯è¡Œçš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰160000000æ¡å­—ç¬¦ä¸²ï¼Œ128ä¸ªæ¡¶æ¯ä¸ªæ¡¶è¿˜æ˜¯æœ‰1250000æ¡ï¼Œè¿™æ ·çš„æ¡¶ç²’åº¦è¿˜æ˜¯å¤ªç²—ã€‚</p>

<p>ç”±äºæˆ‘ä»¬æ‰‹é‡Œæ²¡æœ‰å…¶ä»–åˆ†å¸ƒæƒ…å†µï¼Œä»¥åŠå­—ç¬¦ä¸²å¤§å°åœ¨åŒé•¿åº¦ä¸‹æ˜¯å­—å…¸åºï¼Œæ‰€ä»¥ä»¥å­—ç¬¦ä¸²é•¿åº¦+å‰2-3ä¸ªå­—ç¬¦ä½œä¸ºæ¡¶çš„æ ‡è¯†å°±å¯ä»¥äº†ã€‚</p>

<p>åœ¨æœ¬é¢˜ä¸­ï¼Œç”±äºåªè¿›è¡Œ5è½®queryï¼Œå¹¶ä¸”å†™å¼€é”€éå¸¸å¤§ï¼Œæ•…ä»…å¯¹æ¡¶å†…å­—ç¬¦ä¸²çš„æ•°ç›®è¿›è¡Œç»Ÿè®¡ã€‚</p>

<h3 id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h3>

<ol>
<li>Worker åˆ†åˆ«æ‰«æå¹¶å»ºç«‹æ‰€æœ‰æ¡¶çš„è®¡æ•°</li>
<li>Master æ±‡æ€»æ‰€æœ‰æ¡¶ï¼Œå¹¶å»ºç«‹å…¨å±€æ¡¶</li>
<li>Master é€šè¿‡äºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°(k, n)æ‰€åœ¨çš„å‡ ä¸ªæ¡¶</li>
<li>Master å‘ Worker è¯·æ±‚è·å¾—è¿™äº›æ¡¶å†…çš„æ‰€æœ‰å­—ç¬¦ä¸²</li>
<li>Master å¯¹è¿™äº›å­—ç¬¦ä¸²è¿›è¡Œæ’åºï¼Œå¹¶è¾“å‡ºæœ€ç»ˆç»“æœ</li>
</ol>

<h2 id="å®ç°è¿‡ç¨‹">å®ç°è¿‡ç¨‹</h2>

<p>æœ¬é¢˜å®ç°çš„æœ€å¤§éš¾ç‚¹åœ¨äº I/O å’Œ GC è°ƒä¼˜ï¼Œè¿˜æœ‰å……åˆ†è°ƒåŠ¨ CPUã€‚</p>

<ol>
<li>GC è°ƒä¼˜æˆ‘ä»¬é€šè¿‡ä½¿ç”¨å›ºå®šçš„ buffer æ¥è¿›è¡Œæ“ä½œï¼ŒåŸºæœ¬é¿å…å‡ºç° GCã€‚</li>
<li>é€šè¿‡å¤šçº¿ç¨‹å¤„ç†æ¥ä¿è¯ CPU è°ƒåŠ¨ã€‚</li>
<li>ç½‘ç»œå¼€é”€åœ¨ä¸Šè¿°ç®—æ³•ä¸‹åŸºæœ¬å¿½ç•¥äº†</li>
</ol>

<p>ç„¶è€Œï¼Œå‰©ä¸‹çš„ I/O è°ƒä¼˜è®©äººéå¸¸å¤´å¤§ï¼Œå¹¶ä¼´éšç€å¯èƒ½å­˜åœ¨çš„åŒæ­¥é—®é¢˜ (è¯»å’Œå¤„ç†)</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç¡¬ä»¶æ¡ä»¶ï¼š</p>

<ol>
<li>CPU: 24 core, 2.2GHz</li>
<li>å†…å­˜: 3G heap memory</li>
<li>æ•°æ®ç£ç›˜ï¼šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ</li>
<li>ä¸´æ—¶ã€ç»“æœç£ç›˜ï¼šSSD</li>
</ol>

<h3 id="top-1-çš„æœ€ç»ˆç»“æœ">Top 1 çš„æœ€ç»ˆç»“æœ</h3>

<p>ä»åŸºå‹é‚£å¾—çŸ¥ï¼Œtop 1 çš„å®ç°5è½®æ€»è€—æ—¶(JVMå¯åŠ¨ã€æš‚åœï¼Œä»¥åŠè®¡ç®—)å…±11så¤šï¼Œç”¨æ¥æ¨ç®—è‡ªå·±ç¦»æœ€ä¼˜è¿˜æœ‰å¤šè¿œã€‚</p>

<p>(æˆ‘å®åœ¨æ²¡æƒ³é€šç¬¬ä¸€åæ€ä¹ˆè·‘åˆ°11sçš„ï¼Œå¤§æ¦‚æ˜¯æˆ‘å†…å­˜æ–‡ä»¶ç³»ç»Ÿå¼€çš„ä¸å¯¹ï¼Ÿ)</p>

<h3 id="ä¸ç¨³å®šçš„ioå®ç°">ä¸ç¨³å®šçš„I/Oå®ç°</h3>

<p>æ¯ä¸ªæ–‡ä»¶å•çº¿ç¨‹è¯»ï¼Œå›ºå®š4çº¿ç¨‹å¤„ç†ï¼Œé€šè¿‡é¢„å…ˆåˆ†é…çš„ buffer é¿å…å‡ºç° GCã€‚</p>

<p>å°è£…æ–‡ä»¶æ“ä½œå¹¶è¡Œï¼Œ5ä¸ªæ–‡ä»¶å¹¶è¡Œæ€»å…±å ç”¨ 25 coreã€‚</p>

<p>å®ç°ä¸‹æ¥ç”±äºè¯»å’Œæ“ä½œæ— æ³•æœ‰æ•ˆå¹³è¡¡ï¼Œå¾ˆéš¾åšåˆ°è¯»å®Œå°±æ“ä½œï¼Œå¤§é‡æ—¶é—´èŠ±è´¹åœ¨ç­‰å¾…è¯»çº¿ç¨‹æ–°äº§å‡ºä¸€ä¸ªbufferæˆ–æ˜¯å¤„ç†çº¿ç¨‹å¤„ç†å®Œä¸€ä¸ªbufferã€‚</p>

<p>åœ¨æ¸…ç†ç³»ç»Ÿcacheçš„æƒ…å†µä¸‹ï¼Œå¤§çº¦8så¤„ç†å®Œæ‰€æœ‰å­—ç¬¦ä¸²ï¼Œä¸æ¸…ç†å¤§çº¦ä¸º4sã€‚</p>

<p>è¿™ç§å®ç°æ— æ³•è°ƒä¼˜ï¼Œç­‰å¾…çš„æ—¶é—´å®Œå…¨çœ‹ OS å¿ƒæƒ…ã€‚</p>

<h3 id="ç¨³å®šçš„ioå®ç°">ç¨³å®šçš„I/Oå®ç°</h3>

<p>å…¶å®ä¹‹å‰æåˆ°è¿‡ï¼Œå•çº¿ç¨‹è¯»å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ€è·¯ï¼Œè€Œä¸”ä¸Šè¿°çš„å¤„ç†æ¶æ„å­˜åœ¨ç€ä¸ç¨³å®šçš„ç­‰å¾…é—®é¢˜ã€‚</p>

<p>é‚£ä¹ˆå¦‚ä½•ä½¿å¾—åœ¨ä¿æŒå¤šçº¿ç¨‹è¯»çš„åŒæ—¶èƒ½å¤Ÿå¤šçº¿ç¨‹å¤„ç†ï¼Œå¹¶ä¸”ä¸æµªè´¹æ—¶é—´åœ¨ç­‰å¾…ä¸Šå‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆæ˜¯<strong>æ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»å®Œä¸€ä»½æ•°æ®åï¼Œç›´æ¥è¿›è¡Œå¤„ç†ï¼Œç„¶åè¯»å–ä¸‹ä¸€ä»½</strong>ã€‚</p>

<p>ä½†æ˜¯å¦‚ä½•å®‰æ’æ¯ä¸€ä¸ªçº¿ç¨‹çš„é‚£ä»½æ•°æ®ï¼Œä¿è¯çº¿ç¨‹ä¹‹é—´ä¸ä¼šæœ‰é‡å¤è¯»å–ï¼Œä¹Ÿä¸ä¼šæœ‰æ¼è¯»çš„æ•°æ®å—ï¼Ÿ</p>

<p>è¿™é‡Œé‡‡ç”¨ Eric åœ¨å¤èµ›é‡Œçš„å®ç°: FileSegment, é€šè¿‡å°†ä¸€ä¸ªæ–‡ä»¶åˆ†å‰²ä¸ºä¸€ä¸ªä¸€ä¸ª Segmentï¼Œè®©æ¯ä¸€ä¸ªçº¿ç¨‹è‡ªå·±è¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œå¹¶é€šè¿‡ RandomAccessFile è¿›è¡Œè¯»å–ã€‚(ç”±äºä¸è®¸ç”¨ FileChannel)</p>

<pre><code class="language-java">public class FileSegment {
    private File file;

    private long offset;

    private long size;
    ...
}
</code></pre>

<pre><code class="language-java">public abstract class BufferedFileSegmentReadProcessor implements Runnable {
    private final int bufferMargin = 1024;
    private FileSegmentLoader fileSegmentLoader;
    private int bufferSize;
    private byte[] readBuffer;

    // Here bufferSize must be greater than segments' size got from fileSegmentLoader, 
    // otherwise segment will not be fully read/processed!
    public BufferedFileSegmentReadProcessor(FileSegmentLoader fileSegmentLoader, int bufferSize) {
        this.bufferSize = bufferSize;
        this.fileSegmentLoader = fileSegmentLoader;
    }

    private int readSegment(FileSegment segment, byte[] readBuffer) throws IOException {
        int limit = 0;
        try (RandomAccessFile randomAccessFile = new RandomAccessFile(segment.getFile(), &quot;r&quot;)) {
            randomAccessFile.seek(segment.getOffset());
            limit = randomAccessFile.read(readBuffer, 0, readBuffer.length);
        }
        return limit;
    }

    protected abstract void processSegment(FileSegment segment, byte[] readBuffer, int limit);

    @Override
    public void run() {
        readBuffer = new byte[bufferSize + bufferMargin];
        try {
            FileSegment segment;
            while ((segment = fileSegmentLoader.nextFileSegment()) != null) {
                int limit = readSegment(segment, readBuffer);
                processSegment(segment, readBuffer, limit);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
</code></pre>

<p>è¿™æ ·æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½åœ¨è¯»å’Œå¤„ç†ä¹‹é—´å¾ªç¯ï¼Œå…ˆå®Œæˆçš„çº¿ç¨‹ä¼šè¯·æ±‚ä¸‹ä¸€ä¸ª Segmentï¼Œä¿è¯ä»¥æœ€çŸ­çš„æ—¶é—´å®Œæˆè°ƒç”¨æ‰€æœ‰ Core è¿›è¡Œä¸€éæ•°æ®å¤„ç†ã€‚</p>

<p>è¿™ä¸ªæ–¹æ³•ä¿è¯èƒ½å¤Ÿååˆ†ç¨³å®šçš„è¿›è¡Œè¯»å–å’Œå¤„ç†ï¼Œå¹¶ä¸”ä¸éœ€è¦ç­‰å¾… Reader å’Œ Processor é€šä¿¡ï¼Œåœ¨æˆ‘çš„å®éªŒç¯å¢ƒä¸­åŸºæœ¬å­˜ç€cache 3-4sèƒ½æ‰«æä¸€éï¼Œæ¸…ç†cacheä¹Ÿåœ¨ 7-8sã€‚</p>

<p>å…¶å®åˆ°è¿™é‡Œæœ¬é¢˜å·²ç»å·®ä¸å¤šäº†ï¼Œæˆ‘è®°å¾— Eric åœ¨è¿™ç§å¤„ç†ä¸‹æ¯”èµ›çš„æœ€ç»ˆç»“æœæ˜¯ 14s å¤šã€‚</p>

<h3 id="top-1-çš„ä¼˜åŒ–">Top 1 çš„ä¼˜åŒ–</h3>

<ol>
<li>åœ¨å»ºç«‹æ¡¶çš„æ—¶å€™ï¼ŒåŒæ—¶å°†æ¯ä¸ªæ–‡ä»¶ä¸Šç¬¬iæ¡å­—ç¬¦ä¸²å¯¹åº”çš„offsetã€æ¡¶åºå·å­˜å…¥ä¸¤ä¸ªæ•°ç»„ï¼Œå¹¶å°†æ¡¶ä¿¡æ¯ä»¥åŠè¿™ä¸¤ä¸ªæ•°ç»„ä¸€èµ·å­˜å‚¨åˆ°æœ¬åœ°ï¼Œè¿™æ ·æ„æˆäº†ä¸€ä¸ªå¯ä»¥å¿«é€ŸæŸ¥è¯¢æ¡¶å†…æ‰€æœ‰å­—ç¬¦ä¸²çš„ç´¢å¼•</li>
<li>è¿™äº›ä¿¡æ¯æ€»è®¡å¤§çº¦ 1G å·¦å³ï¼Œé€šè¿‡å»ºç«‹è¿™æ ·çš„ç´¢å¼•ï¼Œæ¯æ¬¡ä»…è®²ç´¢å¼•ä¿¡æ¯è¯»å…¥ï¼Œå¹¶è¿›è¡Œæœ‰é™æ¬¡çš„è¯»å–ï¼Œå°±å¯ä»¥è·å–åˆ°æ‰€æœ‰éœ€è¦çš„å­—ç¬¦ä¸²</li>
</ol>

<p>å¯¹æ¯”ä¹‹ä¸‹ï¼Œä¹‹å‰çš„æ–¹å¼æ˜¯ä»å†…å­˜æ–‡ä»¶ç³»ç»Ÿè¯»å–5Gçš„æ–‡ä»¶ï¼Œç°åœ¨æ˜¯ä»SSDè¯»å–1Gå·¦å³æ–‡ä»¶ï¼Œåªè¦å¹¶å‘è¯»é€Ÿåº¦å·®è·ä¸åœ¨5å€ä»¥ä¸Šï¼Œè¿™æ ·çš„ä¼˜åŒ–æ˜¯èƒ½èŠ‚çœä¸å°‘æ—¶é—´ï¼</p>

<h2 id="æµ‹è¯•">æµ‹è¯•</h2>

<p>ä»…æµ‹è¯•äº†å»º Index</p>

<h3 id="æ¸…ç†-cache">æ¸…ç† cache</h3>

<pre><code class="language-bash">$ sysctl -w vm.drop_caches=3
vm.drop_caches = 3
$ time java ${JAVA_OPTS} -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost 5527 .
[2017-07-27 14:24:27.512] INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527
[2017-07-27 14:24:27.519] INFO com.alibaba.middleware.topkn.TopknWorker Building index ...
0.673: [GC (Allocation Failure) 0.673: [ParNew: 809135K-&gt;99738K(943744K), 0.1759305 secs] 809135K-&gt;542134K(3040896K), 0.1761763 secs] [Times: user=3.15 sys=0.69, real=0.17 secs]
[2017-07-27 14:24:32.330] INFO com.alibaba.middleware.topkn.TopknWorker Index built.
Heap
 par new generation   total 943744K, used 903716K [0x0000000700000000, 0x0000000740000000, 0x0000000740000000)
  eden space 838912K,  95% used [0x0000000700000000, 0x00000007311225e0, 0x0000000733340000)
  from space 104832K,  95% used [0x00000007399a0000, 0x000000073fb06b38, 0x0000000740000000)
  to   space 104832K,   0% used [0x0000000733340000, 0x0000000733340000, 0x00000007399a0000)
 concurrent mark-sweep generation total 2097152K, used 442395K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
 Metaspace       used 3980K, capacity 4638K, committed 4864K, reserved 1056768K
  class space    used 434K, capacity 462K, committed 512K, reserved 1048576K

real    0m5.238s
user    1m11.980s
sys     0m26.324s
</code></pre>

<h3 id="ä¸æ¸…ç†-cache">ä¸æ¸…ç† cache</h3>

<pre><code class="language-bash">$ time java ${JAVA_OPTS} -cp /exp/topkn/topkn.jar com.alibaba.middleware.topkn.TopknWorker localhost 5527 .
[2017-07-27 14:25:39.986] INFO com.alibaba.middleware.topkn.TopknWorker Connecting to master at localhost:5527
[2017-07-27 14:25:39.992] INFO com.alibaba.middleware.topkn.TopknWorker Building index ...
0.590: [GC (Allocation Failure) 0.590: [ParNew: 838912K-&gt;99751K(943744K), 0.1851592 secs] 838912K-&gt;591302K(3040896K), 0.1855308 secs] [Times: user=3.03 sys=0.88, real=0.19 secs]
[2017-07-27 14:25:44.449] INFO com.alibaba.middleware.topkn.TopknWorker Index built.
Heap
 par new generation   total 943744K, used 863664K [0x0000000700000000, 0x0000000740000000, 0x0000000740000000)
  eden space 838912K,  91% used [0x0000000700000000, 0x000000072ea02318, 0x0000000733340000)
  from space 104832K,  95% used [0x00000007399a0000, 0x000000073fb09e00, 0x0000000740000000)
  to   space 104832K,   0% used [0x0000000733340000, 0x0000000733340000, 0x00000007399a0000)
 concurrent mark-sweep generation total 2097152K, used 491550K [0x0000000740000000, 0x00000007c0000000, 0x00000007c0000000)
 Metaspace       used 3980K, capacity 4638K, committed 4864K, reserved 1056768K
  class space    used 434K, capacity 462K, committed 512K, reserved 1048576K

real    0m4.754s
user    0m57.144s
sys     0m30.568s
</code></pre>

<h2 id="æ€»ç»“">æ€»ç»“</h2>

<p>ä»Šå¹´çš„ä¸­é—´ä»¶æ¯”èµ›æ˜¯åœ¨å¾ˆæœ‰æ„æ€ï¼Œè¿™ä¸ªé¢˜ç›®å¯¹å‚èµ›é€‰æ‰‹æœ‰æ¯”è¾ƒé«˜çš„è¦æ±‚ï¼Œè§£é¢˜ä¸­æ¶‰åŠåˆ°å¤šçº¿ç¨‹å¹¶å‘è¯»å†™ã€åˆ†å¸ƒå¼æ’åºã€ç´¢å¼•ã€Socketç¼–ç¨‹ã€JVM è°ƒä¼˜ç­‰å¤šä¸ªæ–¹é¢ï¼Œæˆ‘è¿™ç§ä¸Šæ¥ç›´æ¥æŒ‘çš„æœæ–­æŒ‚äº†ä¸¤ä¸ªç‰ˆæœ¬çš„ä»£ç ï¼Œä¸œçœ‹è¥¿çœ‹å·¦é—®å³é—®ç»ˆäºæŠŠæœ€ç»ˆå½¢å¼ç»™å¼„æ¸…æ¥šäº†ã€‚</p>

<p>è¯´æ˜¯æˆ‘åšçš„ä¸å¦‚è¯´æ˜¯æˆ‘åœ¨å­¦å¦‚ä½•åšï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­å‘ç°äº†å¾ˆå¤šæœ‰æ„ä¹‰çš„æŠ€æœ¯ç‚¹ï¼Œæ­£å‡†å¤‡æ¥ä¸‹æ¥ç»§ç»­å­¦ä¹ ã€‚</p>
      </div>
    </section>
    
    <section class="pagination clearfix">
       
      
      <a class="btn next " href="https://arkbriar.tk/post/majority_voting_al/"> Boyer-Moore Majority Voting Algorithm </a> 
      
    </section>
    
    
<section id="disqus_thread" class='disqus'></section>
<script>
  var disqus_config = function () {
    this.page.url = "https://arkbriar.tk/post/topkn/";
    
  };
  (function() {
    var d = document, s = d.createElement('script');
    s.src = '//crazyark.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

  </div>
  
  <footer>
  <div class="footer-info">
    <p>
      <a href="mailto:arkbriar@gmail.com?subject="><i class="fa fa-envelope-o"></i> arkbriar@gmail.com </a>
      {
        <a href="https://gohugo.io/" title="Hugo :: A fast and modern static website engine">Hugo 0.25.1</a>,
        <a href="https://github.com/IvanChou/yii.im" title="vec">Vec</a> 
      }
      {<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/" title="CC BY-NC-ND 3.0">CC BY-NC-ND 3.0</a>}
    </p>
  </div>
</footer>
  
  <script src="https://arkbriar.tk/js/katex.min.js"></script>
  <script src="https://arkbriar.tk/js/auto-render.min.js"></script>
  <script src="https://arkbriar.tk/js/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
    renderMathInElement(document.body);
  </script>
  

</body>

</html>
